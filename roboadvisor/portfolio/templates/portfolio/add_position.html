{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Position</title>
    
    <!-- Load Main Styles -->
    <link rel="stylesheet" href="{% static 'home_page/style.css' %}">
    <!-- Load Portfolio Styles -->
    <link rel="stylesheet" href="{% static 'portfolio/portfolio.css' %}">
</head>
<body>

<div class="parent">

    <!-- =========================
         SIDEBAR
         ========================= -->
    <div class="div9 sidebar">
        <div class="profile-section">
            <div class="profile-pic"></div>
            <span class="profile-name">{{ user.get_full_name|default:user.username }}</span>
        </div>

        <div class="search-wrapper">
            <input type="text" class="search-bar" placeholder="Search...">
        </div>

        <div class="menu-label">MENU</div>
        
        <nav class="nav-links">
            <a href="{% url 'home' %}" class="nav-item">
                <img src="{% static 'home_page/images/overviewbutton.png' %}" class="nav-icon">
                Overview
            </a>
            <a href="{% url 'ai_advisor' %}" class="nav-item">
                <img src="{% static 'home_page/images/aibutton.png' %}" class="nav-icon">
                AI Advisor
            </a>
            <a href="{% url 'portfolio' %}" class="nav-item">
                <img src="{% static 'home_page/images/portfoliobutton.png' %}" class="nav-icon">
                My Portfolio
            </a>
            <a href="{% url 'stocks' %}" class="nav-item">
                <img src="{% static 'home_page/images/assetsbutton.png' %}" class="nav-icon">
                Stocks
            </a>
            <a href="{% url 'account' %}" class="nav-item active">
                <img src="{% static 'home_page/images/logbutton.png' %}" class="nav-icon">
                Manage Account
            </a>
        </nav>

        <div class="sidebar-footer">ROBOADVISOR</div>
    </div>

    <!-- =========================
         HEADER
         ========================= -->
    <div class="div5 header-section">
        <div class="header-left">
            <span class="header-label neon-text">MENU</span>
            <span class="header-divider">/</span>
            <span id="header-title" class="header-current">Add New Position</span>
        </div>
        <div class="header-right">
            <button class="icon-btn" id="theme-toggle">
                <img src="{% static 'home_page/images/night.png' %}" alt="Theme">
            </button>
            <button class="icon-btn">
                <img src="{% static 'home_page/images/history.png' %}" alt="History">
            </button>
            <button class="icon-btn">
                <img src="{% static 'home_page/images/web.png' %}" alt="Web">
            </button>
        </div>
    </div>
    
    <!-- =========================
        MAIN CONTENT
        ========================= -->
    <div class="portfolio-main-content">

        <!-- Form Card -->
        <div class="pf-card summary-card" style="grid-column: 1 / 3; padding: 40px; position: relative; min-height: 750px;">
            <div class="summary-header">
                <span class="summary-label">Add New Position</span>
            </div>

            <form method="POST" class="add-position-form" style="margin-top: 30px;">
                {% csrf_token %}
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="stock_id">Stock</label>
                    <select name="stock_id" id="stock_id" class="search-bar" required>
                        <option value="">-- Select Stock --</option>
                        <option value="AAPL">Apple (AAPL)</option>
                        <option value="TSLA">Tesla (TSLA)</option>
                        <option value="MSFT">Microsoft (MSFT)</option>
                        <option value="AMZN">Amazon (AMZN)</option>
                        <option value="NVDA">Nvidia (NVDA)</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="quantity">Quantity</label>
                    <input type="number" name="quantity" id="quantity" class="search-bar" placeholder="Enter Quantity" required>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="purchase_price">Purchase Price</label>
                    <input type="number" step="0.01" name="purchase_price" id="purchase_price" class="search-bar" placeholder="Price will auto-fill" readonly>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="total_cost">Total Cost</label>
                    <input type="number" step="0.01" name="total_cost" id="total_cost" class="search-bar" placeholder="Automatically calculated" readonly>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="purchase_date">Purchase Date</label>
                    <input type="date" name="purchase_date" id="purchase_date" class="search-bar" required>
                </div>

                <div class="summary-actions" style="position: relative; margin-top: 70px; display: flex; gap: 15px;">
                    <button type="submit" class="action-btn btn-black">Add Position</button>
                    <a href="{% url 'portfolio' %}" class="action-btn btn-light" style="text-decoration: none; text-align: center;">Cancel</a>
                </div>
            </form>
        </div>

    </div>

    <script>
        const themeBtn = document.getElementById('theme-toggle');
        const body = document.body;

        if (localStorage.getItem('theme') === 'light') {
            body.classList.add('light-mode');
        }

        themeBtn.addEventListener('click', () => {
            body.classList.toggle('light-mode');
            localStorage.setItem('theme', body.classList.contains('light-mode') ? 'light' : 'dark');
        });
    </script>

    <script>
        // Elements
        const stockSelect = document.getElementById('stock_id');
        const priceInput = document.getElementById('purchase_price');
        const quantityInput = document.getElementById('quantity');
        const totalInput = document.getElementById('total_cost');

        // Update total cost
        function updateTotal() {
            const price = parseFloat(priceInput.value) || 0;
            const qty = parseInt(quantityInput.value) || 0;
            totalInput.value = (price * qty).toFixed(2);
        }

        // Fetch latest price from Django view
        stockSelect.addEventListener('change', function() {
            const ticker = this.value;
            if (!ticker) {
                priceInput.value = '';
                totalInput.value = '';
                return;
            }

            priceInput.value = 'Fetching price...';

            fetch(`/portfolio/get-latest-price/?ticker=${ticker}`)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.price !== null) {
                        priceInput.value = parseFloat(data.price).toFixed(2);
                        updateTotal();
                    } else {
                        priceInput.value = '';
                        totalInput.value = '';
                        console.error(`No price returned for ticker: ${ticker}`);
                    }
                })
                .catch(err => {
                    console.error('Error fetching latest price:', err);
                    priceInput.value = '';
                    totalInput.value = '';
                });
        });

        // Update total when quantity changes
        quantityInput.addEventListener('input', updateTotal);
    </script>





</body>
</html>
